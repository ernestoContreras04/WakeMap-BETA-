<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="A new Flutter project.">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#0175C2">

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="tfg_definitivo2">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>tfg_definitivo2</title>
  <link rel="manifest" href="manifest.json">
</head>
<body>
  <!-- Google Maps JavaScript API: Using the same API key as Android for consistency -->
  <!-- Load Google Maps JS optimally: async + defer + loading=async helps performance -->
  <!-- Note: geometry library is needed for polyline encoding/decoding -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB5Nc_EBy8tO9Wyh0K0B96RDkN9d-MET_4&libraries=places,geometry&loading=async" onload="initDirectionsService()"></script>

  <!-- Helper functions using Google Maps JavaScript API (avoids CORS issues) -->
  <script>
    let directionsServiceReady = false;
    let directionsService = null;
    let placesServiceReady = false;
    let placesService = null;
    let placesAutocompleteServiceReady = false;
    let placesAutocompleteService = null;

    function initDirectionsService() {
      if (typeof google !== 'undefined' && google.maps && google.maps.DirectionsService) {
        directionsService = new google.maps.DirectionsService();
        directionsServiceReady = true;
        console.log('Directions service initialized');
      }
      
      // Inicializar servicio de Places
      if (typeof google !== 'undefined' && google.maps && google.maps.places) {
        // Crear un div oculto para el PlacesService
        const hiddenDiv = document.createElement('div');
        hiddenDiv.style.display = 'none';
        document.body.appendChild(hiddenDiv);
        
        placesService = new google.maps.places.PlacesService(hiddenDiv);
        placesAutocompleteService = new google.maps.places.AutocompleteService();
        placesServiceReady = true;
        placesAutocompleteServiceReady = true;
        console.log('Places service initialized');
      }
    }

    // Function to fetch directions and return encoded polyline
    window.fetchDirections = function(originLat, originLng, destLat, destLng, callback) {
      if (!directionsServiceReady) {
        // Wait a bit and retry
        setTimeout(() => {
          if (directionsServiceReady) {
            window.fetchDirections(originLat, originLng, destLat, destLng, callback);
          } else {
            callback({ success: false, error: 'Directions service not ready' });
          }
        }, 500);
        return;
      }

      directionsService.route({
        origin: new google.maps.LatLng(originLat, originLng),
        destination: new google.maps.LatLng(destLat, destLng),
        travelMode: google.maps.TravelMode.DRIVING,
      }, function(result, status) {
        if (status === 'OK' && result.routes && result.routes.length > 0) {
          const route = result.routes[0];
          const encoded = route.overview_polyline.points;
          callback({ success: true, encoded: encoded });
        } else {
          callback({ success: false, error: status });
        }
      });
    };

    // Function to search for a place using Google Places API
    window.searchPlace = function(query, callback) {
      if (!placesServiceReady || !placesAutocompleteServiceReady) {
        // Wait a bit and retry
        setTimeout(() => {
          if (placesServiceReady && placesAutocompleteServiceReady) {
            window.searchPlace(query, callback);
          } else {
            callback({ success: false, error: 'Places service not ready' });
          }
        }, 500);
        return;
      }

      try {
        // Usar AutocompleteService para buscar
        placesAutocompleteService.getPlacePredictions({
          input: query,
          types: ['geocode'],
          language: 'es'
        }, function(predictions, status) {
          if (status === google.maps.places.PlacesServiceStatus.OK && predictions && predictions.length > 0) {
            // Obtener el primer resultado y sus detalles
            const placeId = predictions[0].place_id;
            
            // Obtener detalles del lugar
            placesService.getDetails({
              placeId: placeId,
              fields: ['formatted_address', 'geometry', 'name']
            }, function(place, detailsStatus) {
              if (detailsStatus === google.maps.places.PlacesServiceStatus.OK && place && place.geometry && place.geometry.location) {
                const location = place.geometry.location;
                callback({
                  success: true,
                  latitude: location.lat(),
                  longitude: location.lng(),
                  address: place.formatted_address || place.name || query
                });
              } else {
                callback({ success: false, error: detailsStatus || 'No location found' });
              }
            });
          } else {
            callback({ success: false, error: status || 'No predictions found' });
          }
        });
      } catch (error) {
        console.error('Error in searchPlace:', error);
        callback({ success: false, error: error.toString() });
      }
    };
  </script>

  <script src="flutter_bootstrap.js" async></script>
</body>
</html>
